<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>IsivoltPro - Control de Inventario</title>
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:#f0f4f8;min-height:100vh}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{background:linear-gradient(135deg,#1e3c72,#2a5298);padding:16px 20px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.3)}
.header h1{color:#fff;font-size:20px;font-weight:700}
.header-sub{color:rgba(255,255,255,.8);font-size:11px}
.btn-save{background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.4);color:#fff;padding:7px 12px;border-radius:8px;font-size:12px;cursor:pointer;font-weight:600}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{
  display:flex;
  gap:6px;
  padding:10px 10px 8px;
  background:linear-gradient(180deg,#ffffff, #f7f9ff);
  border-bottom:1px solid #e6ecff;
  position:sticky;top:60px;z-index:99;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
}
.tabs::-webkit-scrollbar{display:none}
.tab{
  flex:0 0 auto;
  padding:10px 14px;
  border:none;
  background:transparent;
  font-size:12px;
  color:#6b7280;
  cursor:pointer;
  border-radius:999px;
  white-space:nowrap;
  font-weight:700;
  transition:all .18s ease;
  display:flex;align-items:center;gap:8px;
}
.tab:hover{transform:translateY(-1px);color:#111827}
.tab.active{
  color:#0b1b3a;
  background:linear-gradient(135deg,#a8c0ff,#74b9ff,#a29bfe);
  box-shadow:0 10px 24px rgba(42,82,152,.18);
}
.tab .tab-badge{
  background:#ff4757;
  color:#fff;
  border-radius:999px;
  padding:2px 7px;
  font-size:10px;
  margin-left:2px;
  font-weight:900;
  box-shadow:0 6px 14px rgba(231,76,60,.22);
}

.content{padding:16px;max-width:680px;margin:0 auto}
.tab-content{display:none}.tab-content.active{display:block}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:#fff;border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 2px 8px rgba(0,0,0,.07)}
.card-title{font-size:14px;font-weight:700;color:#1e3c72;margin-bottom:12px;display:flex;align-items:center;gap:6px}

/* ‚îÄ‚îÄ KPIs ‚îÄ‚îÄ */
.kpi-row{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:14px}
.kpi{border-radius:14px;padding:16px;color:#fff;position:relative;overflow:hidden}
.kpi-val{font-size:36px;font-weight:800;line-height:1}
.kpi-lbl{font-size:12px;opacity:.9;margin-top:4px}
.kpi-bar{height:5px;background:rgba(255,255,255,.3);border-radius:3px;margin-top:10px;overflow:hidden}
.kpi-bar-fill{height:100%;background:rgba(255,255,255,.9);border-radius:3px;transition:width .5s}
.kpi-blue{background:linear-gradient(135deg,#1e3c72,#2a5298)}
.kpi-green{background:linear-gradient(135deg,#27ae60,#1e8449)}
.kpi-red{background:linear-gradient(135deg,#e74c3c,#c0392b)}
.kpi-orange{background:linear-gradient(135deg,#f39c12,#d35400)}

/* ‚îÄ‚îÄ T√âCNICOS CON HERRAMIENTAS (hero dashboard) ‚îÄ‚îÄ */
.dashboard-hero{
  position:relative;
  overflow:hidden;
  border-radius:18px;
  padding:18px 16px 16px;
  background:linear-gradient(135deg,#0d1f4e,#1e3c72,#2a5298);
  color:#fff;
  box-shadow:0 16px 40px rgba(13,31,78,.25);
  margin-bottom:14px;
}
.dashboard-hero:before,
.dashboard-hero:after{
  content:"";
  position:absolute;
  width:220px;height:220px;border-radius:50%;
  filter:blur(0px);
  opacity:.35;
}
.dashboard-hero:before{left:-60px;top:-70px;background:radial-gradient(circle,#74b9ff,transparent 65%)}
.dashboard-hero:after{right:-80px;bottom:-90px;background:radial-gradient(circle,#a29bfe,transparent 62%)}
.hero-top{display:flex;align-items:center;justify-content:space-between;gap:12px;position:relative;z-index:2}
.hero-title{font-size:18px;font-weight:900;letter-spacing:.2px}
.hero-sub{font-size:12px;opacity:.9;margin-top:2px}
.hero-chip{background:rgba(255,255,255,.14);border:1px solid rgba(255,255,255,.18);padding:7px 10px;border-radius:999px;font-size:11px;font-weight:800;white-space:nowrap}
.hero-kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:14px;position:relative;z-index:2}
.hero-kpi{
  background:rgba(255,255,255,.14);
  border:1px solid rgba(255,255,255,.18);
  border-radius:14px;
  padding:10px 10px 9px;
  backdrop-filter: blur(6px);
}
.hero-kpi .lbl{font-size:11px;opacity:.9;font-weight:700}
.hero-kpi .val{font-size:18px;font-weight:900;margin-top:2px}
.hero-kpi .hint{font-size:10px;opacity:.85;margin-top:1px}

.tecnico-card{
  background:linear-gradient(135deg,#ffffff,#f7f9ff);
  border-radius:16px;
  padding:14px 14px;
  margin-bottom:10px;
  box-shadow:0 10px 26px rgba(17,24,39,.08);
  border:1px solid #e9edff;
  display:flex;
  gap:12px;
  align-items:flex-start;
  position:relative;
}
.tecnico-card:before{
  content:"";
  position:absolute;left:0;top:0;bottom:0;width:6px;border-radius:16px 0 0 16px;
  background:linear-gradient(180deg,#ff7675,#fdcb6e,#74b9ff);
}
.tecnico-card.libre{
  opacity:.9;
}
.tecnico-card.libre:before{
  background:linear-gradient(180deg,#55efc4,#00b894,#74b9ff);
}
.tecnico-avatar{
  width:48px;height:48px;border-radius:16px;
  background:linear-gradient(135deg,#1e3c72,#74b9ff,#a29bfe);
  color:#fff;display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:900;flex-shrink:0;
  box-shadow:0 10px 20px rgba(42,82,152,.18);
}
.tecnico-info{flex:1}
.tecnico-name{font-weight:900;color:#0b1b3a;font-size:14px}
.tecnico-sub{font-size:12px;color:#6b7280;margin-top:2px}
.tecnico-tools{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
.tecnico-tool{
  background:linear-gradient(135deg,#eef4ff,#ffffff);
  border:1px solid #e6ecff;
  color:#1e3c72;
  padding:4px 8px;
  border-radius:999px;
  font-size:11px;
  font-weight:800
}

/* ‚îÄ‚îÄ SCAN ‚îÄ‚îÄ */
.scan-section{text-align:center;padding:10px 0}
video{width:100%;max-width:400px;border-radius:12px;display:none;margin:12px auto}
.scan-mode-tabs{display:flex;gap:8px;margin-bottom:16px}
.scan-mode-btn{flex:1;padding:12px;border:2px solid #e0e0e0;background:#fff;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;color:#666;transition:all .2s}
.scan-mode-btn.active{border-color:#1e3c72;background:#f0f4ff;color:#1e3c72}
.scan-state-box{background:#f8f9ff;border:2px dashed #c0ccee;border-radius:12px;padding:20px;margin:12px 0;text-align:center}
.scan-state-icon{font-size:50px;margin-bottom:8px}
.scan-pending{background:#fff3e0;border:2px solid #ffb74d;border-radius:12px;padding:14px;margin:10px 0;text-align:left}
.scan-step{display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid #ffe0b2}
.scan-step:last-child{border-bottom:none}
.step-num{width:28px;height:28px;border-radius:50%;background:#f39c12;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:13px;flex-shrink:0}
.step-num.done{background:#27ae60}
.step-num.active{background:#1e3c72;animation:pulse 1s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}

/* ‚îÄ‚îÄ MATERIALES ‚îÄ‚îÄ */
.tool-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.07);border-left:4px solid #27ae60}
.tool-card.out{border-left-color:#e74c3c}
.tool-name{font-weight:700;font-size:15px;color:#1a1a2e;margin-bottom:4px}
.tool-meta{font-size:12px;color:#777;display:flex;flex-wrap:wrap;gap:8px;margin-bottom:8px}
.tool-meta span{display:flex;align-items:center;gap:3px}
.tag{display:inline-block;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600}
.tag-cat{background:#e8f4fd;color:#1e6091}
.tag-avail{background:#d5f5e3;color:#1e8449}
.tag-out{background:#fadbd8;color:#922b21}
.tag-loc{background:#fef9e7;color:#9a7d0a}
.action-row{display:flex;gap:8px;margin-top:10px}

/* ‚îÄ‚îÄ PERSONAL ‚îÄ‚îÄ */
.worker-card{background:#fff;border-radius:12px;padding:14px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,.07);display:flex;gap:12px;align-items:flex-start}
.worker-avatar{width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;flex-shrink:0}

/* ‚îÄ‚îÄ HISTORIAL ‚îÄ‚îÄ */
.hist-item{display:flex;gap:12px;align-items:flex-start;padding:10px 0;border-bottom:1px solid #f0f0f0}
.hist-item:last-child{border-bottom:none}
.hist-dot{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.hist-dot.out{background:#ffebee}
.hist-dot.in{background:#e8f5e9}

/* ‚îÄ‚îÄ BOTONES ‚îÄ‚îÄ */
.btn{padding:10px 18px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;box-shadow:0 3px 10px rgba(30,60,114,.3)}
.btn-success{background:linear-gradient(135deg,#27ae60,#1e8449);color:#fff}
.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}
.btn-ghost{background:#f0f4f8;color:#1e3c72;border:1px solid #d0d8e8}
.btn-sm{padding:6px 12px;font-size:12px}
.btn-full{width:100%;justify-content:center;padding:14px}
.btn:active{transform:scale(.97)}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.form-group{margin-bottom:14px}
.form-group label{display:block;font-size:13px;font-weight:600;color:#444;margin-bottom:5px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:11px 14px;border:2px solid #e0e8f0;border-radius:8px;font-size:14px;transition:border .2s;background:#fff}
.form-group input:focus,.form-group select:focus{outline:none;border-color:#2a5298}
.search-bar{position:relative;margin-bottom:14px}
.search-bar input{padding-left:38px;background:#f8fafc;border-color:#e8ecf0}
.search-bar::before{content:'üîç';position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:15px}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;align-items:flex-end;justify-content:center}
.modal.active{display:flex}
.modal-box{background:#fff;border-radius:20px 20px 0 0;padding:24px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-title{font-size:18px;font-weight:700;color:#1e3c72;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
.modal-close{background:none;border:none;font-size:22px;cursor:pointer;color:#999}

/* ‚îÄ‚îÄ NOTIFICACI√ìN MEJORADA ‚îÄ‚îÄ */
.notif{position:fixed;top:16px;right:16px;left:16px;max-width:420px;margin:0 auto;background:#fff;padding:14px 18px;border-radius:14px;box-shadow:0 8px 30px rgba(0,0,0,.18);display:flex;align-items:center;gap:12px;z-index:2000;animation:slideIn .35s cubic-bezier(.175,.885,.32,1.275)}
@keyframes slideIn{from{transform:translateY(-90px) scale(.9);opacity:0}to{transform:translateY(0) scale(1);opacity:1}}
.notif.success{border-left:5px solid #27ae60;background:linear-gradient(135deg,#fff,#f0fff4)}
.notif.error{border-left:5px solid #e74c3c;background:linear-gradient(135deg,#fff,#fff5f5)}
.notif.warning{border-left:5px solid #f39c12;background:linear-gradient(135deg,#fff,#fffbf0)}
.notif.info{border-left:5px solid #2a5298;background:linear-gradient(135deg,#fff,#f0f4ff)}
.notif-icon{font-size:26px;flex-shrink:0}
.notif-text{font-size:14px;color:#333;font-weight:600;line-height:1.4}
.notif-sub{font-size:12px;color:#888;font-weight:400;margin-top:2px}
.notif-close{margin-left:auto;background:none;border:none;font-size:18px;color:#bbb;cursor:pointer;padding:0 4px;flex-shrink:0}

/* ‚îÄ‚îÄ PANTALLA BIENVENIDA ‚îÄ‚îÄ */
.splash{position:fixed;inset:0;background:linear-gradient(135deg,#0d1f4e,#1e3c72,#2a5298);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;transition:opacity .7s ease}
.splash.hide{opacity:0;pointer-events:none}
.splash-logo{font-size:72px;animation:logoBounce .9s ease both}
.splash-title{color:#fff;font-size:34px;font-weight:800;margin-top:14px;letter-spacing:2px;text-shadow:0 2px 10px rgba(0,0,0,.3)}
.splash-sub{color:rgba(255,255,255,.7);font-size:14px;margin-top:6px;letter-spacing:1px}
.splash-bar{width:220px;height:5px;background:rgba(255,255,255,.2);border-radius:3px;margin-top:32px;overflow:hidden}
.splash-bar-fill{height:100%;background:linear-gradient(90deg,#74b9ff,#fff);border-radius:3px;animation:loadBar 2s ease forwards}
.splash-dots{display:flex;gap:8px;margin-top:20px}
.splash-dot{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.3)}
.splash-dot.active{background:#fff;animation:dotPulse .6s ease infinite alternate}
.splash-dot:nth-child(2){animation-delay:.2s}.splash-dot:nth-child(3){animation-delay:.4s}
@keyframes logoBounce{0%{transform:scale(0) rotate(-30deg)}60%{transform:scale(1.25) rotate(8deg)}80%{transform:scale(.95)}100%{transform:scale(1) rotate(0)}}
@keyframes loadBar{from{width:0}to{width:100%}}
@keyframes dotPulse{from{opacity:.3;transform:scale(.8)}to{opacity:1;transform:scale(1.2)}}

/* ‚îÄ‚îÄ TOGGLE SONIDO ‚îÄ‚îÄ */
.sound-toggle{position:fixed;bottom:22px;right:18px;z-index:500;background:linear-gradient(135deg,#1e3c72,#2a5298);border:none;border-radius:50%;width:52px;height:52px;color:#fff;font-size:22px;cursor:pointer;box-shadow:0 4px 18px rgba(30,60,114,.45);transition:all .25s;display:flex;align-items:center;justify-content:center}
.sound-toggle:active{transform:scale(.88)}
.sound-toggle.muted{background:linear-gradient(135deg,#999,#666);box-shadow:0 4px 12px rgba(0,0,0,.2)}

/* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
.bar-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.bar-label{width:110px;font-size:12px;color:#555;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;flex-shrink:0}
.bar-track{flex:1;height:22px;background:#f0f4f8;border-radius:4px;overflow:hidden}
.bar-fill{height:100%;background:linear-gradient(90deg,#1e3c72,#2a5298);border-radius:4px;display:flex;align-items:center;padding:0 8px;color:#fff;font-size:11px;font-weight:700;min-width:28px;transition:width .4s}

/* ‚îÄ‚îÄ QUICK ACTIONS ‚îÄ‚îÄ */
.qa-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:14px}
.qa-btn{background:linear-gradient(135deg,#1e3c72,#2a5298);color:#fff;border:none;border-radius:12px;padding:16px 10px;font-size:12px;font-weight:600;cursor:pointer;text-align:center;transition:all .2s;box-shadow:0 3px 10px rgba(30,60,114,.25)}
.qa-btn:active{transform:scale(.96)}
.qa-icon{font-size:26px;display:block;margin-bottom:6px}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty{text-align:center;padding:40px 20px;color:#aaa}
.empty-icon{font-size:48px;margin-bottom:10px}

/* ‚îÄ‚îÄ ALERT ITEMS ‚îÄ‚îÄ */
.alert-box{background:#fff9e6;border:1px solid #ffd54f;border-left:4px solid #f39c12;border-radius:10px;padding:12px;margin-bottom:10px}
.alert-box.critical{background:#ffebee;border-color:#ef9a9a;border-left-color:#e74c3c}
.alert-actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.alert-btn{padding:5px 12px;border-radius:6px;border:1px solid currentColor;background:#fff;font-size:12px;font-weight:600;cursor:pointer}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:400px){.kpi-val{font-size:28px}.tecnico-name{font-size:14px}}
</style>
</head>
<body>

<!-- SPLASH SCREEN -->
<div class="splash" id="splash">
  <div class="splash-logo">‚ö°</div>
  <div class="splash-title">IsivoltPro</div>
  <div class="splash-sub">Control Inteligente de Inventario</div>
  <div class="splash-bar"><div class="splash-bar-fill"></div></div>
  <div class="splash-dots">
    <div class="splash-dot active"></div>
    <div class="splash-dot active"></div>
    <div class="splash-dot active"></div>
  </div>
</div>

<!-- BOT√ìN SONIDO -->
<button class="sound-toggle" id="soundBtn" onclick="toggleSound()" title="Activar/desactivar sonido">üîä</button>

<!-- HEADER -->
<div class="header">
  <div>
    <div class="header h1" style="color:#fff;font-size:20px;font-weight:800">‚ö° IsivoltPro</div>
    <div class="header-sub">Control inteligente de inventario</div>
  </div>
  <button class="btn-save" onclick="downloadApp()">üíæ Guardar App</button>
</div>

<!-- TABS -->
<div class="tabs">
  <button class="tab active" onclick="switchTab('dashboard',this)">üìä Panel</button>
  <button class="tab" onclick="switchTab('scan',this)">üì∑ Escanear</button>
  <button class="tab" onclick="switchTab('tools',this)">üì¶ Materiales</button>
  <button class="tab" onclick="switchTab('workers',this)">üë∑ Personal</button>
  <button class="tab" onclick="switchTab('history',this)">üìã Historial</button>
</div>

<div class="content">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-dashboard" class="tab-content active">
  <div class="dashboard-hero">
    <div class="hero-top">
      <div>
        <div class="hero-title">Panel principal</div>
        <div class="hero-sub">Inventario ‚Ä¢ movimientos ‚Ä¢ pr√©stamos</div>
      </div>
      <div class="hero-chip">‚ö° IsiVolt Pro</div>
    </div>
    <div class="hero-kpis">
      <div class="hero-kpi">
        <div class="lbl">Material total</div>
        <div class="val" id="heroTotal">0</div>
        <div class="hint">unidades registradas</div>
      </div>
      <div class="hero-kpi">
        <div class="lbl">En uso</div>
        <div class="val" id="heroInUse">0</div>
        <div class="hint">salidas activas</div>
      </div>
      <div class="hero-kpi">
        <div class="lbl">Personal</div>
        <div class="val" id="heroWorkers">0</div>
        <div class="hint">t√©cnicos disponibles</div>
      </div>
    </div>
  </div>


  <div class="kpi-row">
    <div class="kpi kpi-blue">
      <div class="kpi-val" id="kpi-total">0</div>
      <div class="kpi-lbl">üì¶ Total Materiales</div>
    </div>
    <div class="kpi kpi-green">
      <div class="kpi-val" id="kpi-avail">0</div>
      <div class="kpi-lbl">‚úÖ Disponibles</div>
      <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi-avail-bar"></div></div>
    </div>
    <div class="kpi kpi-red">
      <div class="kpi-val" id="kpi-use">0</div>
      <div class="kpi-lbl">üîß En Uso</div>
      <div class="kpi-bar"><div class="kpi-bar-fill" id="kpi-use-bar"></div></div>
    </div>
    <div class="kpi kpi-orange">
      <div class="kpi-val" id="kpi-pers">0</div>
      <div class="kpi-lbl">üë∑ Personal Activo</div>
    </div>
  </div>

  <!-- ALERTAS -->
  <div class="card" id="alerts-card" style="display:none">
    <div class="card-title">‚ö†Ô∏è Atenci√≥n requerida <span class="tab-badge" id="alert-count">0</span></div>
    <div id="alerts-body"></div>
  </div>

  <!-- T√âCNICOS CON HERRAMIENTAS ‚Äî bloque principal -->
  <div class="card">
    <div class="card-title">üîß Herramientas por T√©cnico</div>
    <div id="tecnicos-lista"></div>
  </div>

  <!-- GR√ÅFICO ACTIVIDAD SEMANAL -->
  <div class="card">
    <div class="card-title">üìà Actividad Semanal</div>
    <div id="weekly-chart" style="display:flex;align-items:flex-end;justify-content:space-around;height:90px;gap:6px;padding-bottom:4px;border-bottom:2px solid #e8ecf0"></div>
    <div style="display:flex;justify-content:space-around;margin-top:4px" id="weekly-labels"></div>
  </div>

  <!-- TOP MATERIALES -->
  <div class="card">
    <div class="card-title">üî• Materiales M√°s Usados</div>
    <div id="top-materials"></div>
  </div>

  <!-- ACCIONES R√ÅPIDAS -->
  <div class="qa-grid">
    <button class="qa-btn" onclick="switchTab('scan',document.querySelectorAll('.tab')[1])">
      <span class="qa-icon">üì∑</span>Escanear QR
    </button>
    <button class="qa-btn" onclick="openAddTool()">
      <span class="qa-icon">‚ûï</span>A√±adir Material
    </button>
    <button class="qa-btn" onclick="exportExcel()">
      <span class="qa-icon">üìä</span>Exportar Excel
    </button>
    <button class="qa-btn" onclick="exportBackupJSON()">
      <span class="qa-icon">‚¨áÔ∏è</span>Backup JSON
    </button>
    <button class="qa-btn" onclick="openImportModal()">
      <span class="qa-icon">üì•</span>Importar JSON
    </button>
    <button class="qa-btn" onclick="undoLastMovement()">
      <span class="qa-icon">‚Ü©Ô∏è</span>Deshacer
    </button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ESCANEAR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-scan" class="tab-content">

  <!-- Modo de escaneo -->
  <div class="scan-mode-tabs">
    <button class="scan-mode-btn active" id="mode-btn-normal" onclick="setScanMode('normal')">
      üì¶ Modo Normal
    </button>
    <button class="scan-mode-btn" id="mode-btn-tecnico" onclick="setScanMode('tecnico')">
      üë∑ Modo T√©cnico
    </button>
  </div>

  <!-- MODO NORMAL -->
  <div id="mode-normal">
    <div class="scan-section">
      <div class="scan-state-box">
        <div class="scan-state-icon">üì∑</div>
        <div style="font-weight:700;font-size:16px;margin-bottom:6px">Escanear C√≥digo QR</div>
        <div style="color:#888;font-size:13px">Escanea el QR de un material para registrar entrada/salida</div>
      </div>
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas" style="display:none"></canvas>
      <div id="scanResult"></div>
      <button id="startScanBtn" class="btn btn-primary btn-full" onclick="startScanning()">üì∑ Iniciar Escaneo</button>
      <button id="stopScanBtn" class="btn btn-ghost btn-full" style="display:none;margin-top:8px" onclick="stopScanning()">‚èπ Detener</button>
    </div>
  </div>

  <!-- MODO T√âCNICO: primero escanea t√©cnico, luego herramienta -->
  <div id="mode-tecnico" style="display:none">
    <div class="scan-pending" id="tecnico-flow-box">
      <div style="font-weight:700;font-size:15px;color:#e65100;margin-bottom:10px">‚ö° Modo T√©cnico ‚Äî Flujo de 2 pasos</div>

      <div class="scan-step">
        <div class="step-num active" id="step1-num">1</div>
        <div>
          <div style="font-weight:600;font-size:13px">Escanear QR del T√©cnico</div>
          <div style="font-size:12px;color:#888" id="step1-info">Pide al t√©cnico su tarjeta QR personal</div>
        </div>
      </div>
      <div class="scan-step">
        <div class="step-num" id="step2-num">2</div>
        <div>
          <div style="font-weight:600;font-size:13px">Escanear QR de la Herramienta</div>
          <div style="font-size:12px;color:#888" id="step2-info">Escanea el QR pegado en la herramienta</div>
        </div>
      </div>
    </div>

    <div class="scan-section">
      <video id="video2" autoplay playsinline></video>
      <canvas id="canvas2" style="display:none"></canvas>
      <div id="scanResult2"></div>
      <button id="startScanBtn2" class="btn btn-primary btn-full" onclick="startScanning2()">üì∑ Iniciar Escaneo T√©cnico</button>
      <button id="stopScanBtn2" class="btn btn-ghost btn-full" style="display:none;margin-top:8px" onclick="stopScanning2()">‚èπ Detener</button>
      <button id="resetFlowBtn" class="btn btn-ghost btn-full" style="display:none;margin-top:8px" onclick="resetTecnicoFlow()">üîÑ Reiniciar flujo</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MATERIALES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-tools" class="tab-content">
  <div class="search-bar">
    <input type="text" id="search-tools" placeholder="Buscar material..." oninput="renderTools()">
  </div>
  <button class="btn btn-primary btn-full" style="margin-bottom:14px" onclick="openAddTool()">‚ûï A√±adir Material</button>
  <div id="tools-list"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PERSONAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-workers" class="tab-content">
  <div class="search-bar">
    <input type="text" id="search-workers" placeholder="Buscar personal..." oninput="renderWorkers()">
  </div>
  <button class="btn btn-primary btn-full" style="margin-bottom:14px" onclick="openAddWorker()">‚ûï A√±adir Personal</button>
  <div id="workers-list"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORIAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="tab-history" class="tab-content">
  <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
    <select id="filter-type" onchange="renderHistory()" style="flex:1;padding:9px;border:2px solid #e0e8f0;border-radius:8px;font-size:13px">
      <option value="">Todos los movimientos</option>
      <option value="out">Solo Salidas</option>
      <option value="in">Solo Entradas</option>
    </select>
    <select id="filter-worker" onchange="renderHistory()" style="flex:1;padding:9px;border:2px solid #e0e8f0;border-radius:8px;font-size:13px">
      <option value="">Todo el personal</option>
    </select>
  </div>
  <div style="display:flex;gap:8px;margin-bottom:14px">
    <input type="date" id="filter-from" onchange="renderHistory()" style="flex:1;padding:9px;border:2px solid #e0e8f0;border-radius:8px;font-size:13px">
    <input type="date" id="filter-to" onchange="renderHistory()" style="flex:1;padding:9px;border:2px solid #e0e8f0;border-radius:8px;font-size:13px">
  </div>
  <div style="display:flex;gap:8px;margin-bottom:14px">
    <button class="btn btn-primary" style="flex:1" onclick="exportExcel()">üìä Excel</button>
    <button class="btn btn-ghost" style="flex:1" onclick="exportCSV()">üìÑ CSV</button>
  </div>
  <div id="history-stats" class="card" style="margin-bottom:14px"></div>
  <div id="history-list"></div>
</div>

</div><!-- /content -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Modal Movimiento -->
<div class="modal" id="modal-movement">
  <div class="modal-box">
    <div class="modal-title">
      <span id="mv-title">Registrar Movimiento</span>
      <button class="modal-close" onclick="closeModal('modal-movement')">‚úï</button>
    </div>
    <div id="mv-content"></div>
  </div>
</div>

<!-- Modal A√±adir Material -->
<div class="modal" id="modal-tool">
  <div class="modal-box">
    <div class="modal-title">
      <span>üì¶ A√±adir Material</span>
      <button class="modal-close" onclick="closeModal('modal-tool')">‚úï</button>
    </div>
    <div class="form-group"><label>Nombre *</label><input id="t-name" placeholder="Ej: Taladro Bosch"></div>
    <div class="form-group"><label>C√≥digo *</label><input id="t-code" placeholder="Ej: MAT-001"></div>
    <div class="form-group"><label>Categor√≠a</label>
      <select id="t-cat">
        <option value="">-- Seleccionar --</option>
        <option>Herramientas</option><option>Material El√©ctrico</option>
        <option>Equipos</option><option>Consumibles</option>
        <option>EPIs</option><option>Otro</option>
      </select>
    </div>
    <div class="form-group"><label>Ubicaci√≥n</label><input id="t-loc" placeholder="Ej: Almac√©n A - Estante 3"></div>
    <div class="form-group"><label>Descripci√≥n</label><input id="t-desc" placeholder="Detalles adicionales"></div>
    <button class="btn btn-primary btn-full" onclick="saveTool()">üíæ Guardar Material</button>
  </div>
</div>

<!-- Modal A√±adir Personal -->
<div class="modal" id="modal-worker">
  <div class="modal-box">
    <div class="modal-title">
      <span>üë∑ A√±adir Personal</span>
      <button class="modal-close" onclick="closeModal('modal-worker')">‚úï</button>
    </div>
    <div class="form-group"><label>Nombre completo *</label><input id="w-name" placeholder="Ej: Juan Garc√≠a"></div>
    <div class="form-group"><label>C√≥digo empleado *</label><input id="w-code" placeholder="Ej: EMP-001"></div>
    <div class="form-group"><label>Departamento</label>
      <select id="w-dept">
        <option value="">-- Seleccionar --</option>
        <option>El√©ctrico</option><option>Fontaner√≠a</option>
        <option>Carpinter√≠a</option><option>Mantenimiento</option>
        <option>Producci√≥n</option><option>Almac√©n</option><option>Otro</option>
      </select>
    </div>
    <div class="form-group"><label>Tel√©fono</label><input id="w-phone" type="tel" placeholder="612345678"></div>
    <div class="form-group"><label>Email</label><input id="w-email" type="email" placeholder="juan@empresa.com"></div>
    <button class="btn btn-primary btn-full" onclick="saveWorker()">üíæ Guardar Personal</button>
  </div>
</div>

<!-- Modal QR -->
<div class="modal" id="modal-qr">
  <div class="modal-box" style="text-align:center">
    <div class="modal-title">
      <span>üì± C√≥digo QR</span>
      <button class="modal-close" onclick="closeModal('modal-qr')">‚úï</button>
    </div>
    <div id="qr-item-info" style="margin-bottom:14px"></div>
    <div id="qr-wrapper" style="min-height:280px;display:flex;align-items:center;justify-content:center">
      <div style="color:#aaa">‚è≥ Generando...</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-primary" style="flex:1" onclick="downloadQR()">üíæ Descargar</button>
      <button class="btn btn-ghost" style="flex:1" onclick="printQR()">üñ®Ô∏è Imprimir</button>
    </div>
  </div>
</div>

<!-- Modal Devolver herramienta desde tarjeta t√©cnico -->
<div class="modal" id="modal-return">
  <div class="modal-box">
    <div class="modal-title">
      <span id="return-title">üì• Devolver Herramienta</span>
      <button class="modal-close" onclick="closeModal('modal-return')">‚úï</button>
    </div>
    <div id="return-content"></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATOS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let tools   = JSON.parse(localStorage.getItem('iv_tools')   || '[]');
let workers = JSON.parse(localStorage.getItem('iv_workers') || '[]');
let history = JSON.parse(localStorage.getItem('iv_history') || '[]');

function save(){
  localStorage.setItem('iv_tools',   JSON.stringify(tools));
  localStorage.setItem('iv_workers', JSON.stringify(workers));
  localStorage.setItem('iv_history', JSON.stringify(history));
}

// Datos de ejemplo si est√° vac√≠o
if(!tools.length){
  tools=[
    {id:'t1',name:'Taladro Bosch',code:'MAT-001',category:'Herramientas',location:'Almac√©n A-1',description:'Taladro percutor 750W',status:'available',assignedTo:null},
    {id:'t2',name:'Mult√≠metro Fluke',code:'MAT-002',category:'Equipos',location:'Taller',description:'Digital true RMS',status:'available',assignedTo:null},
    {id:'t3',name:'Cable 2.5mm 100m',code:'MAT-003',category:'Material El√©ctrico',location:'Almac√©n B-5',description:'Unipolar azul',status:'available',assignedTo:null},
    {id:'t4',name:'Amper√≠metro',code:'MAT-004',category:'Equipos',location:'Almac√©n A-2',description:'Pinza amperim√©trica',status:'available',assignedTo:null},
  ];
  workers=[
    {id:'w1',name:'Juan Garc√≠a',code:'EMP-001',department:'El√©ctrico',phone:'612345678',email:'juan@empresa.com'},
    {id:'w2',name:'Mar√≠a L√≥pez',code:'EMP-002',department:'Mantenimiento',phone:'698765432',email:'maria@empresa.com'},
    {id:'w3',name:'Carlos Ruiz',code:'EMP-003',department:'Producci√≥n',phone:'655111222',email:'carlos@empresa.com'},
  ];
  save();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVEGACI√ìN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(name, btn){
  document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name).classList.add('active');
  if(btn) btn.classList.add('active');
  if(name==='dashboard') renderDashboard();
  if(name==='tools')     renderTools();
  if(name==='workers')   renderWorkers();
  if(name==='history')   renderHistory();
  if(name==='scan')      resetTecnicoFlow();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDashboard(){
  const total  = tools.length;
  const avail  = tools.filter(t=>t.status==='available').length;
  const inUse  = tools.filter(t=>t.status==='out').length;
  const active = new Set(tools.filter(t=>t.assignedTo).map(t=>t.assignedTo)).size;

  document.getElementById('kpi-total').textContent = total;
  document.getElementById('kpi-avail').textContent = avail;
  document.getElementById('kpi-use').textContent   = inUse;
  document.getElementById('kpi-pers').textContent  = active;

  // Hero KPIs (pesta√±a principal)
  const hTotal = document.getElementById('heroTotal');
  const hUse   = document.getElementById('heroInUse');
  const hWork  = document.getElementById('heroWorkers');
  if(hTotal) hTotal.textContent = total;
  if(hUse)   hUse.textContent   = inUse;
  if(hWork)  hWork.textContent  = active;

  const pct = total>0 ? inUse/total*100 : 0;
  document.getElementById('kpi-avail-bar').style.width = (100-pct)+'%';
  document.getElementById('kpi-use-bar').style.width   = pct+'%';

  renderAlerts();
  renderTecnicos();
  renderWeekly();
  renderTopMaterials();
}

function renderAlerts(){
  const card   = document.getElementById('alerts-card');
  const body   = document.getElementById('alerts-body');
  const badge  = document.getElementById('alert-count');
  const now    = new Date();
  const alerts = [];

  history.forEach(h=>{
    if(h.type!=='out') return;
    const tool = tools.find(t=>t.id===h.toolId);
    if(!tool||tool.status!=='out') return;
    const days = Math.floor((now-new Date(h.date))/(864e5));
    if(days>=5) alerts.push({tool,days,workerName:h.workerName,workerId:h.workerId});
  });

  // Deduplicar por herramienta
  const seen=new Set();
  const uniq = alerts.filter(a=>{ if(seen.has(a.tool.id)) return false; seen.add(a.tool.id); return true; });
  uniq.sort((a,b)=>b.days-a.days);

  badge.textContent = uniq.length;
  if(!uniq.length){ card.style.display='none'; return; }
  card.style.display='block';

  body.innerHTML = uniq.map(a=>{
    const w = workers.find(x=>x.id===a.workerId);
    const cls = a.days>15 ? 'critical' : '';
    return `<div class="alert-box ${cls}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <strong>${a.days>15?'üî¥':'‚ö†Ô∏è'} ${a.tool.name}</strong>
          <div style="font-size:12px;color:#666;margin-top:2px">T√©cnico: <strong>${a.workerName}</strong> ¬∑ Hace ${a.days} d√≠as</div>
        </div>
        <span style="font-size:11px;font-weight:700;color:${a.days>15?'#c62828':'#e65100'}">${a.days}d</span>
      </div>
      <div class="alert-actions">
        ${w&&w.phone?`<button class="alert-btn" onclick="window.location.href='tel:${w.phone}'" style="color:#1e3c72">üìû Llamar</button>`:''}
        <button class="alert-btn" onclick="quickReturn('${a.tool.id}')" style="color:#27ae60">üì• Devolver</button>
      </div>
    </div>`;
  }).join('');
}

function renderTecnicos(){
  const el = document.getElementById('tecnicos-lista');
  // T√©cnicos con herramientas
  const conHerramientas = workers.map(w=>{
    const assigned = tools.filter(t=>t.assignedTo===w.id);
    return {...w, assigned};
  });
  // Ordenar: primero los que tienen herramientas
  conHerramientas.sort((a,b)=>b.assigned.length-a.assigned.length);

  if(!conHerramientas.length){ el.innerHTML='<div class="empty"><div class="empty-icon">üë∑</div><div>Sin personal registrado</div></div>'; return; }

  el.innerHTML = conHerramientas.map(w=>{
    const initials = w.name.split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase();
    const libre = w.assigned.length===0;
    return `<div class="tecnico-card ${libre?'libre':''}">
      <div class="tecnico-avatar">${initials}</div>
      <div class="tecnico-info">
        <div class="tecnico-name">${w.name}</div>
        <div class="tecnico-dept">${w.department||'Sin departamento'} ¬∑ ${w.code}</div>
        ${libre
          ? '<div class="tecnico-libre">‚úÖ Sin herramientas asignadas</div>'
          : w.assigned.map(t=>{
              const lastOut = [...history].find(h=>h.toolId===t.id&&h.type==='out');
              const days = lastOut ? Math.floor((new Date()-new Date(lastOut.date))/864e5) : 0;
              const cls  = days>15?'critico':'';
              const dcls = days>15?'':'dias-badge '+(days>7?'warn':'ok');
              return `<span class="herramienta-tag ${cls}" onclick="quickReturn('${t.id}')">
                üîß ${t.name} <span class="${dcls}" style="${days>15?'background:#c62828;color:#fff;border-radius:10px;padding:2px 6px;font-size:10px;font-weight:700':''}">${days}d</span>
              </span>`;
            }).join('')
        }
        ${w.phone?`<a href="tel:${w.phone}" class="tecnico-phone">üìû ${w.phone}</a>`:''}
      </div>
    </div>`;
  }).join('');
}

function renderWeekly(){
  const chart  = document.getElementById('weekly-chart');
  const labels = document.getElementById('weekly-labels');
  const now    = new Date();
  const days   = ['L','M','X','J','V','S','D'];
  const counts = [0,0,0,0,0,0,0];

  history.forEach(h=>{
    const diff = Math.floor((now-new Date(h.date))/864e5);
    if(diff<7){ const idx=6-diff; if(idx>=0) counts[idx]++; }
  });

  const max = Math.max(...counts,1);
  chart.innerHTML = counts.map((v,i)=>{
    const h = Math.round(v/max*80);
    return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:flex-end">
      <div style="width:100%;background:${v>0?'linear-gradient(180deg,#1e3c72,#2a5298)':'#e8ecf0'};height:${Math.max(h,4)}px;border-radius:4px 4px 0 0;position:relative" title="${v} movimientos">
        ${v>0?`<span style="position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:10px;font-weight:700;color:#1e3c72">${v}</span>`:''}
      </div>
    </div>`;
  }).join('');

  const todayIdx = (new Date().getDay()+6)%7;
  labels.innerHTML = counts.map((_,i)=>`<div style="flex:1;text-align:center;font-size:11px;color:${i===todayIdx?'#1e3c72':'#aaa'};font-weight:${i===todayIdx?'700':'400'}">${days[i]}</div>`).join('');
}

function renderTopMaterials(){
  const el = document.getElementById('top-materials');
  const cnt = {};
  history.forEach(h=>{ if(h.type==='out') cnt[h.toolName]=(cnt[h.toolName]||0)+1; });
  const top = Object.entries(cnt).sort((a,b)=>b[1]-a[1]).slice(0,5);
  if(!top.length){ el.innerHTML='<div style="color:#aaa;font-size:13px;text-align:center;padding:10px">Sin datos de uso a√∫n</div>'; return; }
  const max = top[0][1];
  el.innerHTML = top.map(([name,v])=>`
    <div class="bar-row">
      <div class="bar-label" title="${name}">${name}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${v/max*100}%">${v}</div></div>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESCANEO ‚Äî MODO NORMAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let videoStream=null, scanning=false;

async function startScanning(){
  try{
    if(!navigator.mediaDevices?.getUserMedia){ showNotif('Tu navegador no soporta c√°mara','error'); return; }
    const vid = document.getElementById('video');
    videoStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    vid.srcObject=videoStream; vid.style.display='block';
    document.getElementById('startScanBtn').style.display='none';
    document.getElementById('stopScanBtn').style.display='block';
    document.getElementById('scanResult').innerHTML='';
    scanning=true;
    vid.onloadedmetadata=()=>{ vid.play(); scanLoop(); };
  }catch(e){ handleCamError(e,'scanResult','startScanBtn'); }
}
function stopScanning(){
  scanning=false;
  if(videoStream){ videoStream.getTracks().forEach(t=>t.stop()); videoStream=null; }
  const vid=document.getElementById('video');
  vid.style.display='none';
  document.getElementById('startScanBtn').style.display='block';
  document.getElementById('stopScanBtn').style.display='none';
}
function scanLoop(){
  if(!scanning) return;
  const vid=document.getElementById('video'), cvs=document.getElementById('canvas');
  const ctx=cvs.getContext('2d');
  if(vid.readyState===vid.HAVE_ENOUGH_DATA){
    cvs.width=vid.videoWidth; cvs.height=vid.videoHeight;
    ctx.drawImage(vid,0,0);
    const img=ctx.getImageData(0,0,cvs.width,cvs.height);
    const code=jsQR(img.data,img.width,img.height);
    if(code){ playSound('scan'); handleQR(code.data); return; }
  }
  requestAnimationFrame(scanLoop);
}

function handleQR(data){
  stopScanning();
  try{
    const d=JSON.parse(data);
    if(d.type==='tool'){
      const tool=tools.find(t=>t.id===d.id);
      if(tool) openMovementModal(tool);
      else showNotif('Herramienta no encontrada en el sistema','error');
    } else if(d.type==='worker'){
      showNotif(`T√©cnico: ${d.name} ‚Äî Usa el Modo T√©cnico para vincular herramientas`,'success');
    } else { showNotif('QR no reconocido','error'); }
  }catch(e){ showNotif('QR inv√°lido o no compatible','error'); }
}

function handleCamError(e, resultId, btnId){
  let msg='';
  if(e.name==='NotAllowedError'||e.name==='PermissionDeniedError')
    msg='‚ùå Permiso denegado. Toca el üîí de la barra de direcci√≥n ‚Üí Permisos ‚Üí C√°mara ‚Üí Permitir ‚Üí Recarga.';
  else if(e.name==='NotFoundError') msg='‚ùå No se encontr√≥ c√°mara en el dispositivo.';
  else if(e.name==='NotReadableError') msg='‚ùå La c√°mara est√° en uso por otra app.';
  else msg='‚ùå Error de c√°mara: '+e.message;
  showNotif(msg,'error');
  if(resultId) document.getElementById(resultId).innerHTML=`<div style="color:#e74c3c;font-size:13px;padding:10px;background:#ffebee;border-radius:8px;margin-top:10px">${msg}</div>`;
  if(btnId) document.getElementById(btnId).style.display='block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ESCANEO ‚Äî MODO T√âCNICO (2 pasos)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let scanMode='normal', tecnicoStep=1, tecnicoScanned=null;
let videoStream2=null, scanning2=false;

function setScanMode(mode){
  scanMode=mode;
  document.getElementById('mode-normal').style.display   = mode==='normal'  ?'block':'none';
  document.getElementById('mode-tecnico').style.display  = mode==='tecnico' ?'block':'none';
  document.getElementById('mode-btn-normal').classList.toggle('active',  mode==='normal');
  document.getElementById('mode-btn-tecnico').classList.toggle('active', mode==='tecnico');
  if(mode==='tecnico') resetTecnicoFlow();
}

function resetTecnicoFlow(){
  tecnicoStep=1; tecnicoScanned=null;
  if(scanning2) stopScanning2();
  document.getElementById('step1-num').className='step-num active';
  document.getElementById('step2-num').className='step-num';
  document.getElementById('step1-info').textContent='Pide al t√©cnico su tarjeta QR personal';
  document.getElementById('step2-info').textContent='Escanea el QR pegado en la herramienta';
  document.getElementById('scanResult2').innerHTML='';
  document.getElementById('startScanBtn2').style.display='block';
  document.getElementById('startScanBtn2').textContent='üì∑ Paso 1: Escanear QR del T√©cnico';
  document.getElementById('stopScanBtn2').style.display='none';
  document.getElementById('resetFlowBtn').style.display='none';
}

async function startScanning2(){
  try{
    if(!navigator.mediaDevices?.getUserMedia){ showNotif('Tu navegador no soporta c√°mara','error'); return; }
    const vid=document.getElementById('video2');
    videoStream2=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
    vid.srcObject=videoStream2; vid.style.display='block';
    document.getElementById('startScanBtn2').style.display='none';
    document.getElementById('stopScanBtn2').style.display='block';
    document.getElementById('scanResult2').innerHTML='';
    scanning2=true;
    vid.onloadedmetadata=()=>{ vid.play(); scanLoop2(); };
  }catch(e){ handleCamError(e,'scanResult2','startScanBtn2'); }
}
function stopScanning2(){
  scanning2=false;
  if(videoStream2){ videoStream2.getTracks().forEach(t=>t.stop()); videoStream2=null; }
  document.getElementById('video2').style.display='none';
  document.getElementById('stopScanBtn2').style.display='none';
}
function scanLoop2(){
  if(!scanning2) return;
  const vid=document.getElementById('video2'), cvs=document.getElementById('canvas2');
  const ctx=cvs.getContext('2d');
  if(vid.readyState===vid.HAVE_ENOUGH_DATA){
    cvs.width=vid.videoWidth; cvs.height=vid.videoHeight;
    ctx.drawImage(vid,0,0);
    const img=ctx.getImageData(0,0,cvs.width,cvs.height);
    const code=jsQR(img.data,img.width,img.height);
    if(code){ playSound('scan'); handleQR2(code.data); return; }
  }
  requestAnimationFrame(scanLoop2);
}

function handleQR2(data){
  stopScanning2();
  try{
    const d=JSON.parse(data);
    if(tecnicoStep===1){
      // Espera QR de t√©cnico
      if(d.type!=='worker'){ showNotif('‚ö†Ô∏è Escanea el QR del T√âCNICO primero (no de herramienta)','error'); restartStep2Scan(); return; }
      const w=workers.find(x=>x.id===d.id);
      if(!w){ showNotif('T√©cnico no encontrado en el sistema','error'); restartStep2Scan(); return; }
      tecnicoScanned=w;
      tecnicoStep=2;
      // Actualizar UI
      document.getElementById('step1-num').className='step-num done';
      document.getElementById('step1-info').textContent=`‚úÖ T√©cnico: ${w.name}`;
      document.getElementById('step2-num').className='step-num active';
      document.getElementById('scanResult2').innerHTML=`
        <div style="background:#e8f5e9;border:1px solid #a5d6a7;border-radius:10px;padding:12px;margin:10px 0;text-align:left">
          <div style="font-weight:700;color:#2e7d32">‚úÖ T√©cnico identificado</div>
          <div style="font-size:13px;color:#555;margin-top:4px">${w.name} ¬∑ ${w.code} ¬∑ ${w.department||'-'}</div>
        </div>`;
      document.getElementById('startScanBtn2').style.display='block';
      document.getElementById('startScanBtn2').textContent='üì∑ Paso 2: Escanear QR de la Herramienta';
      document.getElementById('resetFlowBtn').style.display='block';
      showNotif(`T√©cnico identificado: ${w.name}`,'success','üë∑','Ahora escanea la herramienta');
    } else {
      // Espera QR de herramienta
      if(d.type!=='tool'){ showNotif('‚ö†Ô∏è Escanea el QR de la HERRAMIENTA','error'); restartStep2Scan(); return; }
      const tool=tools.find(t=>t.id===d.id);
      if(!tool){ showNotif('Herramienta no encontrada en el sistema','error'); restartStep2Scan(); return; }
      // Vincular directamente
      registerTecnicoSalida(tool, tecnicoScanned);
    }
  }catch(e){ showNotif('QR inv√°lido','error'); restartStep2Scan(); }
}

function restartStep2Scan(){
  document.getElementById('startScanBtn2').style.display='block';
}

function registerTecnicoSalida(tool, worker){
  if(tool.status==='out'){
    const prev=workers.find(w=>w.id===tool.assignedTo);
    // Si ya la tiene el mismo t√©cnico, preguntar devoluci√≥n
    if(tool.assignedTo===worker.id){
      document.getElementById('scanResult2').innerHTML=`
        <div style="background:#fff3e0;border:1px solid #ffcc80;border-radius:10px;padding:12px;margin:10px 0">
          <div style="font-weight:700;color:#e65100">‚ö†Ô∏è ${worker.name} ya tiene esta herramienta</div>
          <div style="font-size:13px;color:#555;margin-top:4px">${tool.name}</div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn btn-success" style="flex:1" onclick="doCheckin('${tool.id}');resetTecnicoFlow()">üì• Registrar Devoluci√≥n</button>
            <button class="btn btn-ghost" style="flex:1" onclick="resetTecnicoFlow()">Cancelar</button>
          </div>
        </div>`;
      return;
    }
    // La tiene otro t√©cnico
    document.getElementById('scanResult2').innerHTML=`
      <div style="background:#ffebee;border:1px solid #ef9a9a;border-radius:10px;padding:12px;margin:10px 0">
        <div style="font-weight:700;color:#c62828">‚ùå Herramienta en uso</div>
        <div style="font-size:13px;color:#555;margin-top:4px">${tool.name} est√° asignada a: <strong>${prev?prev.name:'Desconocido'}</strong></div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn btn-danger" style="flex:1" onclick="doForcedTransfer('${tool.id}','${worker.id}');resetTecnicoFlow()">üîÑ Transferir a ${worker.name}</button>
          <button class="btn btn-ghost" style="flex:1" onclick="resetTecnicoFlow()">Cancelar</button>
        </div>
      </div>`;
    return;
  }

  // Herramienta disponible ‚Üí asignar directamente
  doCheckout(tool.id, worker.id);
  document.getElementById('scanResult2').innerHTML=`
    <div style="background:#e8f5e9;border:1px solid #a5d6a7;border-radius:10px;padding:14px;margin:10px 0;text-align:center">
      <div style="font-size:36px;margin-bottom:8px">‚úÖ</div>
      <div style="font-weight:700;color:#2e7d32;font-size:16px">¬°Herramienta Asignada!</div>
      <div style="font-size:13px;color:#555;margin-top:6px">
        <strong>${tool.name}</strong><br>‚Üí <strong>${worker.name}</strong>
      </div>
      <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="resetTecnicoFlow()">‚úÖ Nueva Operaci√≥n</button>
    </div>`;
  showNotif(`${tool.name} ‚Üí ${worker.name}`,'success','‚úÖ','Asignaci√≥n registrada');
}

function doForcedTransfer(toolId, workerId){
  doCheckin(toolId);
  doCheckout(toolId, workerId);
  playSound('transfer');
  showNotif('üîÑ Herramienta transferida correctamente','info','üîÑ','Reasignaci√≥n completada');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MOVIMIENTOS (Normal)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMovementModal(tool){
  const w = tool.assignedTo ? workers.find(x=>x.id===tool.assignedTo) : null;
  document.getElementById('mv-title').textContent = tool.status==='available' ? 'üì§ Registrar Salida' : 'üì• Registrar Entrada';
  document.getElementById('mv-content').innerHTML = tool.status==='available' ? `
    <div class="tool-card" style="margin-bottom:14px">
      <div class="tool-name">${tool.name}</div>
      <div class="tool-meta"><span>üìù ${tool.code}</span>${tool.location?`<span>üìç ${tool.location}</span>`:''}</div>
    </div>
    <div class="form-group">
      <label>Asignar a t√©cnico *</label>
      <select id="sel-worker">
        <option value="">-- Seleccionar t√©cnico --</option>
        ${workers.map(w=>`<option value="${w.id}">${w.name} (${w.code})</option>`).join('')}
      </select>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('modal-movement')">Cancelar</button>
      <button class="btn btn-danger" style="flex:1" onclick="doCheckoutFromModal('${tool.id}')">üì§ Confirmar Salida</button>
    </div>` : `
    <div class="tool-card out" style="margin-bottom:14px">
      <div class="tool-name">${tool.name}</div>
      <div class="tool-meta"><span>üìù ${tool.code}</span></div>
      <div style="font-size:13px;color:#666;margin-top:4px">Asignado a: <strong>${w?w.name:'Desconocido'}</strong></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('modal-movement')">Cancelar</button>
      <button class="btn btn-success" style="flex:1" onclick="doCheckin('${tool.id}');closeModal('modal-movement')">üì• Confirmar Entrada</button>
    </div>`;
  document.getElementById('modal-movement').classList.add('active');
}

function doCheckoutFromModal(toolId){
  const wId=document.getElementById('sel-worker').value;
  if(!wId){ showNotif('Selecciona un t√©cnico','error'); return; }
  doCheckout(toolId,wId);
  closeModal('modal-movement');
}

function doCheckout(toolId, workerId){
  const tool=tools.find(t=>t.id===toolId);
  const worker=workers.find(w=>w.id===workerId);
  if(!tool||!worker) return;
  tool.status='out'; tool.assignedTo=workerId;
  history.unshift({id:Date.now().toString(),date:new Date().toISOString(),type:'out',toolId,toolName:tool.name,workerId,workerName:worker.name});
  save(); renderDashboard(); renderTools();
  playSound('checkout');
  showNotif(`üì§ ${tool.name} ‚Üí ${worker.name}`,'success','üì§','Herramienta prestada');
}

function doCheckin(toolId){
  const tool=tools.find(t=>t.id===toolId);
  if(!tool) return;
  const worker=workers.find(w=>w.id===tool.assignedTo);
  history.unshift({id:Date.now().toString(),date:new Date().toISOString(),type:'in',toolId,toolName:tool.name,workerId:tool.assignedTo,workerName:worker?worker.name:'-'});
  tool.status='available'; tool.assignedTo=null;
  save(); renderDashboard(); renderTools();
  playSound('checkin');
  showNotif(`üì• ${tool.name} devuelta`,'success','üì•','Herramienta disponible de nuevo');
}

function quickReturn(toolId){
  const tool=tools.find(t=>t.id===toolId);
  if(!tool) return;
  const w=tool.assignedTo?workers.find(x=>x.id===tool.assignedTo):null;
  document.getElementById('return-title').textContent='üì• Devolver: '+tool.name;
  document.getElementById('return-content').innerHTML=`
    <div class="tool-card out" style="margin-bottom:14px">
      <div class="tool-name">${tool.name}</div>
      <div class="tool-meta"><span>üìù ${tool.code}</span>${tool.location?`<span>üìç ${tool.location}</span>`:''}</div>
      <div style="font-size:13px;color:#666;margin-top:4px">Asignado a: <strong>${w?w.name:'Desconocido'}</strong></div>
    </div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" style="flex:1" onclick="closeModal('modal-return')">Cancelar</button>
      <button class="btn btn-success" style="flex:1" onclick="doCheckin('${toolId}');closeModal('modal-return')">üì• Confirmar Devoluci√≥n</button>
    </div>`;
  document.getElementById('modal-return').classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MATERIALES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTools(){
  const q=(document.getElementById('search-tools')?.value||'').toLowerCase();
  const el=document.getElementById('tools-list');
  const list=tools.filter(t=>!q||t.name.toLowerCase().includes(q)||t.code.toLowerCase().includes(q)||(t.category||'').toLowerCase().includes(q)||(t.location||'').toLowerCase().includes(q));
  if(!list.length){ el.innerHTML='<div class="empty"><div class="empty-icon">üì¶</div><div>Sin materiales</div></div>'; return; }
  el.innerHTML=list.map(t=>{
    const w=t.assignedTo?workers.find(x=>x.id===t.assignedTo):null;
    return `<div class="tool-card ${t.status==='out'?'out':''}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div class="tool-name">${t.name}</div>
        <span class="tag ${t.status==='available'?'tag-avail':'tag-out'}">${t.status==='available'?'‚úÖ Libre':'üîß En uso'}</span>
      </div>
      <div class="tool-meta">
        <span>üìù ${t.code}</span>
        ${t.category?`<span class="tag tag-cat">${t.category}</span>`:''}
        ${t.location?`<span>üìç ${t.location}</span>`:''}
      </div>
      ${w?`<div style="font-size:13px;color:#e74c3c;font-weight:600;margin-bottom:6px">üë∑ ${w.name}</div>`:''}
      <div class="action-row">
        <button class="btn btn-ghost btn-sm" onclick="showQR('tool','${t.id}')">üì± QR</button>
        ${t.status==='available'
          ?`<button class="btn btn-danger btn-sm" onclick="openMovementModal(tools.find(x=>x.id==='${t.id}'))">üì§ Prestar</button>`
          :`<button class="btn btn-success btn-sm" onclick="doCheckin('${t.id}')">üì• Devolver</button>`}
        <button class="btn btn-ghost btn-sm" onclick="deleteTool('${t.id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

function openAddTool(){ document.getElementById('modal-tool').classList.add('active'); }
function saveTool(){
  const name=document.getElementById('t-name').value.trim();
  const code=document.getElementById('t-code').value.trim();
  if(!name||!code){ showNotif('Nombre y C√≥digo son obligatorios','error'); return; }
  tools.push({id:'t'+Date.now(),name,code,category:document.getElementById('t-cat').value,location:document.getElementById('t-loc').value.trim(),description:document.getElementById('t-desc').value.trim(),status:'available',assignedTo:null});
  save(); closeModal('modal-tool'); renderTools(); renderDashboard();
  ['t-name','t-code','t-loc','t-desc'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('t-cat').value='';
  playSound('save');
  showNotif('Material a√±adido al inventario','success','üì¶','Disponible para asignar');
}
function deleteTool(id){
  if(!confirm('¬øEliminar este material?')) return;
  tools=tools.filter(t=>t.id!==id); save(); renderTools(); renderDashboard();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PERSONAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderWorkers(){
  const q=(document.getElementById('search-workers')?.value||'').toLowerCase();
  const el=document.getElementById('workers-list');
  const list=workers.filter(w=>!q||w.name.toLowerCase().includes(q)||w.code.toLowerCase().includes(q)||(w.department||'').toLowerCase().includes(q));
  if(!list.length){ el.innerHTML='<div class="empty"><div class="empty-icon">üë∑</div><div>Sin personal</div></div>'; return; }
  el.innerHTML=list.map(w=>{
    const assigned=tools.filter(t=>t.assignedTo===w.id);
    const initials=w.name.split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase();
    return `<div class="worker-card">
      <div class="worker-avatar">${initials}</div>
      <div style="flex:1">
        <div style="font-weight:700;font-size:15px">${w.name}</div>
        <div style="font-size:12px;color:#888;margin-bottom:6px">${w.code} ¬∑ ${w.department||'-'}</div>
        ${w.phone?`<a href="tel:${w.phone}" style="color:#1e3c72;font-size:12px;font-weight:600">üìû ${w.phone}</a><br>`:''}
        ${w.email?`<div style="font-size:12px;color:#888">${w.email}</div>`:''}
        ${assigned.length?`<div style="margin-top:8px">${assigned.map(t=>`<span class="tag tag-out" style="margin:2px">${t.name}</span>`).join('')}</div>`:'<div style="font-size:12px;color:#27ae60;margin-top:6px">‚úÖ Sin herramientas</div>'}
        <div class="action-row" style="margin-top:10px">
          <button class="btn btn-ghost btn-sm" onclick="showQR('worker','${w.id}')">üì± QR Personal</button>
          <button class="btn btn-ghost btn-sm" onclick="deleteWorker('${w.id}')">üóëÔ∏è</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function openAddWorker(){ document.getElementById('modal-worker').classList.add('active'); }
function saveWorker(){
  const name=document.getElementById('w-name').value.trim();
  const code=document.getElementById('w-code').value.trim();
  if(!name||!code){ showNotif('Nombre y C√≥digo son obligatorios','error'); return; }
  workers.push({id:'w'+Date.now(),name,code,department:document.getElementById('w-dept').value,phone:document.getElementById('w-phone').value.trim(),email:document.getElementById('w-email').value.trim()});
  save(); closeModal('modal-worker'); renderWorkers(); renderDashboard();
  ['w-name','w-code','w-phone','w-email'].forEach(id=>document.getElementById(id).value='');
  document.getElementById('w-dept').value='';
  playSound('save');
  showNotif('Personal registrado','success','üë∑','Ya puede usar el sistema');
}
function deleteWorker(id){
  if(!confirm('¬øEliminar este trabajador?')) return;
  workers=workers.filter(w=>w.id!==id); save(); renderWorkers(); renderDashboard();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HISTORIAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory(){
  const type   = document.getElementById('filter-type').value;
  const worker = document.getElementById('filter-worker').value;
  const from   = document.getElementById('filter-from').value;
  const to     = document.getElementById('filter-to').value;

  // Poblar select de personal
  const sel=document.getElementById('filter-worker');
  const cur=sel.value;
  sel.innerHTML='<option value="">Todo el personal</option>'+workers.map(w=>`<option value="${w.id}" ${cur===w.id?'selected':''}>${w.name}</option>`).join('');

  let list=history;
  if(type)   list=list.filter(h=>h.type===type);
  if(worker) list=list.filter(h=>h.workerId===worker);
  if(from)   list=list.filter(h=>new Date(h.date)>=new Date(from));
  if(to)     list=list.filter(h=>new Date(h.date)<=new Date(to+'T23:59:59'));

  // Stats
  const outs=list.filter(h=>h.type==='out').length;
  const ins =list.filter(h=>h.type==='in').length;
  document.getElementById('history-stats').innerHTML=`
    <div style="display:flex;gap:16px;flex-wrap:wrap">
      <div><span style="font-size:22px;font-weight:800;color:#1e3c72">${list.length}</span><div style="font-size:11px;color:#888">Total</div></div>
      <div><span style="font-size:22px;font-weight:800;color:#e74c3c">${outs}</span><div style="font-size:11px;color:#888">Salidas</div></div>
      <div><span style="font-size:22px;font-weight:800;color:#27ae60">${ins}</span><div style="font-size:11px;color:#888">Entradas</div></div>
    </div>`;

  const el=document.getElementById('history-list');
  if(!list.length){ el.innerHTML='<div class="empty"><div class="empty-icon">üìã</div><div>Sin registros</div></div>'; return; }
  el.innerHTML='<div class="card">'+list.slice(0,100).map(h=>{
    const d=new Date(h.date);
    return `<div class="hist-item">
      <div class="hist-dot ${h.type}">${h.type==='out'?'üì§':'üì•'}</div>
      <div style="flex:1">
        <div style="font-weight:600;font-size:14px">${h.toolName}</div>
        <div style="font-size:12px;color:#888">${h.workerName}</div>
        <div style="font-size:11px;color:#bbb;margin-top:2px">${d.toLocaleDateString('es-ES')} ¬∑ ${d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'})}</div>
      </div>
      <span style="font-size:11px;font-weight:700;color:${h.type==='out'?'#e74c3c':'#27ae60'};white-space:nowrap">${h.type==='out'?'SALIDA':'ENTRADA'}</span>
    </div>`;
  }).join('')+'</div>';
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CARGA DE LIBRER√çAS (fallback)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function ensureJSQRLoaded(){
  if(window.jsQR) return true;
  const cdns = [
    'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js',
    'https://unpkg.com/jsqr@1.4.0/dist/jsQR.js'
  ];
  for(const url of cdns){
    const ok = await new Promise((resolve)=>{
      const s=document.createElement('script');
      s.src=url;
      s.onload=()=>resolve(!!window.jsQR);
      s.onerror=()=>resolve(false);
      document.head.appendChild(s);
    });
    if(ok) return true;
  }
  return false;
}

async function ensureXLSXLoaded(){
  if(window.XLSX) return true;
  const cdns = [
    'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
    'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'
  ];
  for(const url of cdns){
    const ok = await new Promise((resolve)=>{
      const s=document.createElement('script');
      s.src=url;
      s.onload=()=>resolve(!!window.XLSX);
      s.onerror=()=>resolve(false);
      document.head.appendChild(s);
    });
    if(ok) return true;
  }
  return false;
}

async function ensureCoreLibs(){
  // jsQR es cr√≠tico para escaneo. Si no est√°, lo intentamos recuperar.
  const ok = await ensureJSQRLoaded();
  if(!ok){
    showNotif('No se pudo cargar la librer√≠a de escaneo (jsQR)','warning','‚ö†Ô∏è','Revisa conexi√≥n o bloqueadores (adblock).');
  }
  return ok;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// C√ìDIGOS QR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _qrItem=null, _qrType=null, _qrDataUrl=null;

async function ensureQRCodeLoaded(){
  if(window.QRCode) return true;

  // Intentar cargar la librer√≠a (por si el m√≥vil bloquea un CDN o va lento)
  const cdns = [
    'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
    'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js'
  ];

  for(const url of cdns){
    const ok = await new Promise((resolve)=>{
      const s=document.createElement('script');
      s.src=url;
      s.onload=()=>resolve(!!window.QRCode);
      s.onerror=()=>resolve(false);
      document.head.appendChild(s);
    });
    if(ok) return true;
  }
  return false;
}

async function generateQRDataUrl(payload, opts={}){
  const ok = await ensureQRCodeLoaded();
  if(!ok) throw new Error('No se pudo cargar la librer√≠a QR (sin conexi√≥n o CDN bloqueado)');
  const options = {
    width: 320,
    margin: 2,
    errorCorrectionLevel: 'M',
    color: { dark: '#0b1b3a', light: '#ffffff' },
    ...opts
  };
  return await QRCode.toDataURL(payload, options);
}

async function showQR(type, id){
  const item = type==='tool' ? tools.find(t=>t.id===id) : workers.find(w=>w.id===id);
  if(!item){ showNotif('Elemento no encontrado','error'); return; }
  _qrItem=item; _qrType=type; _qrDataUrl=null;

  document.getElementById('qr-item-info').innerHTML=`
    <div style="font-weight:900;font-size:17px;color:#0b1b3a">${item.name}</div>
    <div style="font-size:13px;color:#6b7280;margin-top:3px">C√≥digo: <b>${item.code}</b></div>`;

  const wrapper=document.getElementById('qr-wrapper');
  wrapper.innerHTML='<div style="color:#9aa3af;font-size:14px">‚è≥ Generando QR‚Ä¶</div>';
  document.getElementById('modal-qr').classList.add('active');

  try{
    const data={type, id:item.id, name:item.name, code:item.code, ts:Date.now()};
    const payload = JSON.stringify(data);

    // Generaci√≥n principal (DataURL) ‚Äî m√°s fiable para descargar/imprimir
    const url = await generateQRDataUrl(payload);

    _qrDataUrl = url;
    wrapper.innerHTML = `
      <img id="qr-img" src="${url}" alt="QR" style="width:260px;height:260px;border-radius:14px;box-shadow:0 12px 24px rgba(0,0,0,.12);background:#fff"/>
      <div style="margin-top:10px;font-size:12px;color:#6b7280">Consejo: imprime y pega este QR en la herramienta / tarjeta NFC</div>
    `;

    // (Opcional) vibra suave al generar
    if(navigator.vibrate) navigator.vibrate(25);
    playSound('save');
  }catch(err){
    console.warn('QR error:', err);
    wrapper.innerHTML = `
      <div style="color:#e74c3c;font-weight:800">‚ùå No se pudo generar el QR</div>
      <div style="color:#6b7280;font-size:12px;margin-top:6px">${(err && err.message) ? err.message : 'Error desconocido'}</div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;justify-content:center">
        <button class="btn btn-primary" onclick="showQR('${type}','${id}')">üîÑ Reintentar</button>
        <button class="btn btn-secondary" onclick="copyQRPayload()">üìã Copiar datos</button>
      </div>`;
    playSound('error');
  }
}

function copyQRPayload(){
  try{
    if(!_qrItem){ showNotif('No hay elemento seleccionado','error'); return; }
    const data={type:_qrType, id:_qrItem.id, name:_qrItem.name, code:_qrItem.code};
    navigator.clipboard?.writeText(JSON.stringify(data))
      .then(()=>showNotif('Datos copiados al portapapeles','success','üìã'))
      .catch(()=>showNotif('No se pudo copiar (permiso del navegador)','warning','‚ö†Ô∏è'));
  }catch(e){ showNotif('No se pudo copiar','error'); }
}

function downloadQR(){
  if(!_qrDataUrl){ showNotif('QR a√∫n no generado, espera un momento','warning'); return; }
  const a=document.createElement('a');
  a.download=`QR-${(_qrItem?.name||'item').replace(/[^\w\- ]+/g,'').trim().replace(/\s+/g,'_')}.png`;
  a.href=_qrDataUrl; a.click();
  showNotif('‚úÖ QR descargado','success','‚¨áÔ∏è');
}

function printQR(){
  if(!_qrDataUrl){ showNotif('QR a√∫n no generado','warning'); return; }
  const w=window.open('','print');
  w.document.write(`
    <html><head><title>Imprimir QR</title>
      <style>
        body{font-family:Arial,sans-serif;text-align:center;padding:24px}
        .box{display:inline-block;border:1px solid #e5e7eb;border-radius:16px;padding:18px}
        h2{margin:0 0 6px;color:#0b1b3a}
        .sub{color:#6b7280;font-size:13px;margin-bottom:14px}
        img{width:320px;height:320px}
        .code{margin-top:10px;font-size:14px;font-weight:800}
      </style>
    </head><body>
      <div class="box">
        <h2>${_qrItem?.name||''}</h2>
        <div class="sub">C√≥digo: ${_qrItem?.code||''}</div>
        <img src="${_qrDataUrl}" />
        <div class="code">‚ö° IsiVolt Pro</div>
      </div>
      
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODAL IMPORTAR BACKUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="modal" id="modal-import">
  <div class="modal-card">
    <div class="modal-title">üì• Importar backup</div>
    <div class="modal-sub" id="importInfo">Selecciona un archivo <b>.json</b> exportado desde IsiVoltPro.</div>
    <input id="importFile" type="file" accept="application/json" style="margin-top:12px;width:100%;padding:12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff"/>
    <div style="display:flex;gap:10px;margin-top:12px">
      <button class="btn btn-secondary" style="flex:1" onclick="closeModal('modal-import')">Cancelar</button>
      <button class="btn btn-primary" style="flex:1" onclick="importBackupJSON()">Importar</button>
    </div>
  </div>
</div>

<script>setTimeout(()=>window.print(),250);<\/script>
    </body></html>
  `);
  w.document.close(); w.focus();
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EXPORTAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportExcel(){
  if(!history.length){ showNotif('No hay datos para exportar','error'); return; }
  if(typeof XLSX==='undefined'){
    showNotif('Cargando Excel...','success');
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
    s.onload=exportExcel; document.head.appendChild(s); return;
  }
  const now=new Date(), fh=now.toLocaleDateString('es-ES'), hh=now.toLocaleTimeString('es-ES');
  const dias=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
  const inUse=tools.filter(t=>t.status==='out').length;
  const avail=tools.filter(t=>t.status==='available').length;
  const wb=XLSX.utils.book_new();

  // Resumen
  const matU={};history.forEach(h=>{if(h.type==='out')matU[h.toolName]=(matU[h.toolName]||0)+1;});
  const topM=Object.entries(matU).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const persU={};history.forEach(h=>{persU[h.workerName]=(persU[h.workerName]||0)+1;});
  const topP=Object.entries(persU).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const res=[['ISIVOLTPRO - REPORTE EJECUTIVO'],[`Generado: ${fh} ${hh}`],[''],
    ['METRICAS GENERALES','Valor'],['Total materiales',tools.length],['Disponibles',avail],['En uso',inUse],
    ['% Uso',tools.length>0?((inUse/tools.length*100).toFixed(1)+'%'):'0%'],['Personal registrado',workers.length],
    ['Total movimientos',history.length],['Total salidas',history.filter(h=>h.type==='out').length],['Total entradas',history.filter(h=>h.type==='in').length],
    [''],['TOP 5 MATERIALES MAS USADOS','Salidas'],...topM,[''],['TOP 5 PERSONAL MAS ACTIVO','Movimientos'],...topP];

  // Historial
  const hist=[['HISTORIAL DE MOVIMIENTOS'],[`Total: ${history.length}`],[''],
    ['N','Fecha','Hora','Dia Semana','Tipo','Material','Cod Material','Ubicacion','Tecnico','Cod Empleado','Departamento']];
  history.forEach((h,i)=>{
    const d=new Date(h.date),w=workers.find(x=>x.id===h.workerId),t=tools.find(x=>x.id===h.toolId);
    hist.push([i+1,d.toLocaleDateString('es-ES'),d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),
      dias[d.getDay()],h.type==='out'?'SALIDA':'ENTRADA',h.toolName||'-',t?t.code:'-',t?t.location||'-':'-',
      h.workerName||'-',w?w.code:'-',w?w.department||'-':'-']);
  });

  // Inventario
  const inv=[['INVENTARIO ACTUAL'],[`Fecha: ${fh}`],[''],
    ['N','Material','Codigo','Categoria','Ubicacion','Descripcion','Estado','Asignado A','Telefono','Departamento']];
  tools.forEach((t,i)=>{
    const w=t.assignedTo?workers.find(x=>x.id===t.assignedTo):null;
    inv.push([i+1,t.name,t.code,t.category||'-',t.location||'-',t.description||'-',
      t.status==='available'?'DISPONIBLE':'EN USO',w?w.name:'-',w?w.phone||'-':'-',w?w.department||'-':'-']);
  });

  // Personal
  const pers=[['LISTADO DE PERSONAL'],[`Fecha: ${fh}`],[''],
    ['N','Nombre','Codigo','Departamento','Telefono','Email','Materiales Asignados','Lista']];
  workers.forEach((w,i)=>{
    const asgn=tools.filter(t=>t.assignedTo===w.id);
    pers.push([i+1,w.name,w.code,w.department||'-',w.phone||'-',w.email||'-',asgn.length,asgn.map(t=>t.name).join(' | ')||'Ninguno']);
  });

  // En uso ahora
  const enUso=[['MATERIALES EN USO AHORA'],[`Fecha: ${fh}  |  En uso: ${inUse}`],[''],
    ['N','Material','Codigo','Categoria','Ubicacion','Tecnico','Telefono','Departamento','Fecha Salida','Dias En Uso']];
  let c=1;
  tools.filter(t=>t.status==='out').forEach(t=>{
    const w=t.assignedTo?workers.find(x=>x.id===t.assignedTo):null;
    const last=[...history].find(h=>h.toolId===t.id&&h.type==='out');
    let fs='-',du='-';
    if(last){const dl=new Date(last.date);fs=dl.toLocaleDateString('es-ES');du=Math.floor((now-dl)/864e5);}
    enUso.push([c++,t.name,t.code,t.category||'-',t.location||'-',w?w.name:'-',w?w.phone||'-':'-',w?w.department||'-':'-',fs,du]);
  });
  if(c===1) enUso.push(['No hay materiales en uso']);

  const add=(data,widths,name)=>{
    const ws=XLSX.utils.aoa_to_sheet(data);
    ws['!cols']=widths.map(w=>({wch:w}));
    XLSX.utils.book_append_sheet(wb,ws,name);
  };
  add(res,    [35,18],                           'Resumen');
  add(hist,   [4,12,8,12,10,24,13,18,20,13,14], 'Historial');
  add(inv,    [4,24,13,16,18,20,11,20,13,14],   'Inventario');
  add(pers,   [4,22,13,14,13,26,10,40],         'Personal');
  add(enUso,  [4,24,13,14,18,20,13,14,15,10],   'En Uso Ahora');

  XLSX.writeFile(wb,`IsivoltPro_${fh.replace(/\//g,'-')}.xlsx`);
  playSound('save');
  showNotif(`Excel descargado: ${history.length} movimientos`,'success','üìä','5 hojas ¬∑ Listo para abrir');
}

function exportCSV(){
  const BOM='\uFEFF';
  let csv=BOM+'N;Fecha;Hora;Tipo;Material;Codigo;Tecnico;Empleado;Departamento\n';
  history.forEach((h,i)=>{
    const d=new Date(h.date),w=workers.find(x=>x.id===h.workerId),t=tools.find(x=>x.id===h.toolId);
    csv+=[i+1,d.toLocaleDateString('es-ES'),d.toLocaleTimeString('es-ES',{hour:'2-digit',minute:'2-digit'}),
      h.type==='out'?'SALIDA':'ENTRADA',`"${h.toolName||''}"`,t?t.code:'',`"${h.workerName||''}"`,
      w?w.code:'',w?w.department||'':''
    ].join(';')+'\n';
  });
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
  a.download=`IsivoltPro_${new Date().toLocaleDateString('es-ES').replace(/\//g,'-')}.csv`;
  a.click(); showNotif('‚úÖ CSV descargado','success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SISTEMA DE SONIDOS (Web Audio API)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let audioCtx = null;
let soundEnabled = localStorage.getItem('iv_sound') !== 'false';

function getAudioCtx(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}

// En m√≥viles, el audio suele estar bloqueado hasta el primer toque del usuario.
// Esto "desbloquea" el AudioContext para que los sonidos funcionen al escanear.
let audioUnlocked = false;
let pendingWelcome = false;

function setupAudioUnlock(){
  const unlock = async ()=>{
    try{
      const ctx = getAudioCtx();
      if(ctx.state === 'suspended') await ctx.resume();
      audioUnlocked = true;
      // peque√±o "tick" inaudible/corto para asegurar arranque (si el navegador lo permite)
      if(soundEnabled){
        playSound('scan');
        if(pendingWelcome){ playSound('welcome'); pendingWelcome=false; }
      }
    }catch(e){ /* ignore */ }
    window.removeEventListener('pointerdown', unlock, true);
    window.removeEventListener('touchstart', unlock, true);
    window.removeEventListener('keydown', unlock, true);
  };
  window.addEventListener('pointerdown', unlock, true);
  window.addEventListener('touchstart', unlock, true);
  window.addEventListener('keydown', unlock, true);
}


function playSound(type){
  if(!soundEnabled) return;
  try{
    const ctx = getAudioCtx();
    if(ctx.state === 'suspended') ctx.resume();

    const sounds = {
      // Salida: tono descendente doble (bip-bip grave)
      checkout: ()=>{
        const t = ctx.currentTime;
        [0, 0.18].forEach((delay, i)=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(880, t+delay);
          osc.frequency.exponentialRampToValueAtTime(440, t+delay+0.15);
          gain.gain.setValueAtTime(0.4, t+delay);
          gain.gain.exponentialRampToValueAtTime(0.001, t+delay+0.18);
          osc.start(t+delay); osc.stop(t+delay+0.2);
        });
      },

      // Entrada: tono ascendente doble (bip-bip agudo ‚Äî confirmar)
      checkin: ()=>{
        const t = ctx.currentTime;
        [0, 0.15].forEach((delay)=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(440, t+delay);
          osc.frequency.exponentialRampToValueAtTime(880, t+delay+0.12);
          gain.gain.setValueAtTime(0.35, t+delay);
          gain.gain.exponentialRampToValueAtTime(0.001, t+delay+0.15);
          osc.start(t+delay); osc.stop(t+delay+0.18);
        });
      },

      // QR escaneado: beep corto tipo pistola lectora
      scan: ()=>{
        const t = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type = 'square';
        osc.frequency.setValueAtTime(1200, t);
        osc.frequency.exponentialRampToValueAtTime(900, t+0.08);
        gain.gain.setValueAtTime(0.2, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t+0.1);
        osc.start(t); osc.stop(t+0.12);
      },

      // Error: tono grave de error
      error: ()=>{
        const t = ctx.currentTime;
        [0, 0.22].forEach(delay=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sawtooth';
          osc.frequency.setValueAtTime(180, t+delay);
          gain.gain.setValueAtTime(0.3, t+delay);
          gain.gain.exponentialRampToValueAtTime(0.001, t+delay+0.2);
          osc.start(t+delay); osc.stop(t+delay+0.22);
        });
      },

      // Alerta: 3 bips urgentes
      alert: ()=>{
        const t = ctx.currentTime;
        [0, 0.2, 0.4].forEach(delay=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.setValueAtTime(660, t+delay);
          gain.gain.setValueAtTime(0.35, t+delay);
          gain.gain.exponentialRampToValueAtTime(0.001, t+delay+0.15);
          osc.start(t+delay); osc.stop(t+delay+0.18);
        });
      },

      // Bienvenida: melod√≠a de inicio (do-mi-sol)
      welcome: ()=>{
        const t = ctx.currentTime;
        const notes = [523, 659, 784, 1046]; // C5 E5 G5 C6
        notes.forEach((freq, i)=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine';
          osc.frequency.value = freq;
          gain.gain.setValueAtTime(0, t + i*0.12);
          gain.gain.linearRampToValueAtTime(0.3, t + i*0.12 + 0.04);
          gain.gain.exponentialRampToValueAtTime(0.001, t + i*0.12 + 0.22);
          osc.start(t + i*0.12);
          osc.stop(t + i*0.12 + 0.25);
        });
      },

      // Guardar/√©xito: ding agradable
      save: ()=>{
        const t = ctx.currentTime;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain); gain.connect(ctx.destination);
        osc.type = 'sine';
        osc.frequency.setValueAtTime(784, t);
        osc.frequency.exponentialRampToValueAtTime(1046, t+0.1);
        gain.gain.setValueAtTime(0.3, t);
        gain.gain.exponentialRampToValueAtTime(0.001, t+0.3);
        osc.start(t); osc.stop(t+0.35);
      },

      // Transferencia: 2 notas distintas
      transfer: ()=>{
        const t = ctx.currentTime;
        [[523, 0],[784, 0.15]].forEach(([freq, delay])=>{
          const osc = ctx.createOscillator();
          const gain = ctx.createGain();
          osc.connect(gain); gain.connect(ctx.destination);
          osc.type = 'sine'; osc.frequency.value = freq;
          gain.gain.setValueAtTime(0.3, t+delay);
          gain.gain.exponentialRampToValueAtTime(0.001, t+delay+0.15);
          osc.start(t+delay); osc.stop(t+delay+0.18);
        });
      }
    };

    if(sounds[type]) sounds[type]();
  }catch(e){ console.warn('Audio error:', e); }
}

function toggleSound(){
  soundEnabled = !soundEnabled;
  localStorage.setItem('iv_sound', soundEnabled);
  const btn = document.getElementById('soundBtn');
  btn.textContent = soundEnabled ? 'üîä' : 'üîá';
  btn.classList.toggle('muted', !soundEnabled);
  if(soundEnabled){ playSound('save'); showNotif('Sonido activado', 'info', 'üîä'); }
  else { showNotif('Sonido desactivado', 'info', 'üîá'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PANTALLA DE BIENVENIDA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initSplash(){
  // Actualizar bot√≥n seg√∫n estado guardado
  if(!soundEnabled){
    document.getElementById('soundBtn').textContent = 'üîá';
    document.getElementById('soundBtn').classList.add('muted');
  }

  setTimeout(()=>{
    const splash = document.getElementById('splash');
    splash.classList.add('hide');
    setTimeout(()=>{ splash.remove(); }, 700);
    // Sonido de bienvenida al entrar (en m√≥vil puede requerir un toque previo)
    if(soundEnabled){
      if(audioUnlocked) playSound('welcome');
      else { pendingWelcome=true; showNotif('Toca la pantalla para activar sonido', 'info', 'üîä'); }
    }
    // Notificaci√≥n de bienvenida
    setTimeout(()=>{
      const hour = new Date().getHours();
      const greet = hour<12 ? '¬°Buenos d√≠as!' : hour<20 ? '¬°Buenas tardes!' : '¬°Buenas noches!';
      showNotif(greet + ' IsivoltPro listo', 'info', '‚ö°', 'Sistema cargado correctamente');
    }, 400);
  }, 2200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BACKUP / RESTAURAR / DESHACER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportBackupJSON(){
  const payload = {
    app: 'IsiVoltPro',
    version: '1.2.0',
    exportedAt: new Date().toISOString(),
    tools, workers, history
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.download = `IsiVoltPro-backup-${stamp}.json`;
  a.href = URL.createObjectURL(blob);
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  showNotif('Backup JSON descargado','success','‚¨áÔ∏è','Gu√°rdalo para restaurar en cualquier momento');
}

function openImportModal(){
  document.getElementById('modal-import').classList.add('active');
  document.getElementById('importFile').value='';
  document.getElementById('importInfo').innerHTML='Selecciona un archivo <b>.json</b> exportado desde IsiVoltPro.';
}

async function importBackupJSON(){
  const input = document.getElementById('importFile');
  const file = input.files?.[0];
  if(!file){ showNotif('Selecciona un archivo .json','warning'); return; }
  try{
    const text = await file.text();
    const payload = JSON.parse(text);
    if(!payload || !payload.tools || !payload.workers || !payload.history){
      throw new Error('Formato de backup no v√°lido');
    }
    tools = payload.tools;
    workers = payload.workers;
    history = payload.history;
    saveAll();
    renderDashboard(); renderTools(); renderWorkers(); renderHistory();
    closeModal('modal-import');
    showNotif('Backup restaurado','success','‚úÖ','Datos cargados correctamente');
  }catch(e){
    showNotif('No se pudo importar el backup','error','‚ùå', e?.message || 'Error desconocido');
  }
}

function undoLastMovement(){
  if(!history.length){ showNotif('No hay movimientos para deshacer','warning'); return; }
  const last = history[0];
  const tool = tools.find(t=>t.id===last.toolId);
  if(tool){
    if(last.type==='out'){
      tool.status='available'; tool.assignedTo=''; tool.assignedToName=''; tool.lastOut=null;
    }else{
      tool.status='out';
      tool.assignedTo=last.workerId||'';
      tool.assignedToName=last.workerName||'';
      tool.lastOut = last.date || Date.now();
    }
  }
  history.shift();
  saveAll();
  renderDashboard(); renderTools(); renderWorkers(); renderHistory();
  showNotif('√öltimo movimiento deshecho','info','‚Ü©Ô∏è',`${last.toolName} ¬∑ ${last.type==='out'?'SALIDA':'ENTRADA'}`);
}

// Atajos de teclado (PC): Ctrl+S backup / Ctrl+Z deshacer
document.addEventListener('keydown',(e)=>{
  if(e.ctrlKey && e.key.toLowerCase()==='z'){ e.preventDefault(); undoLastMovement(); }
  if(e.ctrlKey && e.key.toLowerCase()==='s'){ e.preventDefault(); exportBackupJSON(); }
});

// NOTIFICACIONES MEJORADAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showNotif(msg, type='success', icon=null, sub=''){
  document.querySelectorAll('.notif').forEach(n=>n.remove());
  const icons = {success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è'};
  const ic = icon || icons[type] || '‚úÖ';
  const n = document.createElement('div');
  n.className = `notif ${type}`;
  n.innerHTML = `
    <div class="notif-icon">${ic}</div>
    <div style="flex:1">
      <div class="notif-text">${msg}</div>
      ${sub ? `<div class="notif-sub">${sub}</div>` : ''}
    </div>
    <button class="notif-close" onclick="this.parentElement.remove()">‚úï</button>`;
  document.body.appendChild(n);
  // Sonido autom√°tico seg√∫n tipo
  if(type==='error') playSound('error');
  if(type==='warning') playSound('alert');
  setTimeout(()=>{
    n.style.animation = 'slideIn .3s ease reverse';
    setTimeout(()=>n.remove(), 280);
  }, 4500);
}

function downloadApp(){
  const a=document.createElement('a');
  a.href=location.href; a.download='IsivoltPro.html'; a.click();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async ()=>{
  await ensureCoreLibs();
  renderDashboard();
  // precargar listados para evitar pantallas vac√≠as al cambiar de pesta√±a
  if(typeof renderTools==='function') renderTools();
  if(typeof renderWorkers==='function') renderWorkers();
  if(typeof renderHistory==='function') renderHistory();
  setupAudioUnlock();
  initSplash();
})();
</script>
</body>
</html>
